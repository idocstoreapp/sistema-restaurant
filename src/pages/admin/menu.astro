---
import AdminLayout from '../../layouts/AdminLayout.astro';
import CategoryManager from '../../react/components/CategoryManager';
import MenuItemManager from '../../react/components/MenuItemManager';
import { supabase } from '../../lib/supabase';

// Verificar autenticaciÃ³n
const { data: { user }, error: authError } = await supabase.auth.getUser();

if (authError || !user) {
  return Astro.redirect('/admin/login');
}

// Verificar que el usuario tenga rol de admin o encargado
const { data: userProfile } = await supabase
  .from('users')
  .select('role')
  .eq('id', user.id)
  .single();

if (!userProfile || !['admin', 'encargado'].includes(userProfile.role)) {
  return Astro.redirect('/admin/login');
}

// Obtener tab activo de la URL
const activeTab = Astro.url.searchParams.get('tab') || 'items';
---

<AdminLayout title="GestiÃ³n del MenÃº - Admin">
  <div class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto">
      <!-- Header -->
      <header class="mb-8">
        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4 mb-6">
          <div>
            <h1 class="text-2xl md:text-4xl font-cinzel text-gold-400">GestiÃ³n del MenÃº</h1>
            <p class="text-gold-300/70 mt-1">Administra productos, categorÃ­as y precios</p>
          </div>
          <div class="flex gap-3">
            <a 
              href="/" 
              target="_blank"
              class="bg-black/50 text-gold-400 px-4 py-2 rounded-lg hover:bg-black/70 transition flex items-center gap-2 border border-gold-600"
            >
              ğŸ‘ï¸ Ver MenÃº
            </a>
            <a 
              href="/menu-imprimible" 
              target="_blank"
              class="bg-black/50 text-gold-400 px-4 py-2 rounded-lg hover:bg-black/70 transition flex items-center gap-2 border border-gold-600"
            >
              ğŸ–¨ï¸ VersiÃ³n Imprimible
            </a>
          </div>
        </div>

        <!-- Tabs de navegaciÃ³n -->
        <nav class="flex gap-2 border-b-2 border-gold-600/30 pb-0">
          <a 
            href="/admin/menu?tab=items"
            class={`px-6 py-3 rounded-t-lg transition font-medium ${
              activeTab === 'items' 
                ? 'bg-gold-600 text-black' 
                : 'bg-black/50 text-gold-400 hover:bg-black/70'
            }`}
          >
            ğŸ½ï¸ Items del MenÃº
          </a>
          <a 
            href="/admin/menu?tab=categories"
            class={`px-6 py-3 rounded-t-lg transition font-medium ${
              activeTab === 'categories' 
                ? 'bg-gold-600 text-black' 
                : 'bg-black/50 text-gold-400 hover:bg-black/70'
            }`}
          >
            ğŸ“ CategorÃ­as
          </a>
        </nav>
      </header>

      <!-- Contenido segÃºn tab activo -->
      <div class="bg-black/30 p-4 md:p-6 rounded-lg border-2 border-gold-600">
        {activeTab === 'items' && (
          <MenuItemManager client:load />
        )}
        {activeTab === 'categories' && (
          <CategoryManager client:load />
        )}
      </div>

      <!-- InformaciÃ³n adicional -->
      <div class="mt-8 bg-black/30 border border-gold-600/30 rounded-lg p-4">
        <h3 class="text-gold-400 font-semibold mb-2">ğŸ’¡ Consejos</h3>
        <ul class="text-gold-300/80 text-sm space-y-1">
          <li>â€¢ Los cambios se reflejan inmediatamente en el menÃº pÃºblico y la versiÃ³n imprimible</li>
          <li>â€¢ Usa "Ocultar" para items temporalmente no disponibles (no los pierdas)</li>
          <li>â€¢ Las imÃ¡genes se optimizan automÃ¡ticamente y cargan rÃ¡pido</li>
          <li>â€¢ Puedes reordenar items y categorÃ­as cambiando el nÃºmero de "Orden"</li>
        </ul>
      </div>
    </div>
  </div>
</AdminLayout>

